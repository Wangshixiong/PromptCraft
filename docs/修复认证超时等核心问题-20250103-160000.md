# 修复认证超时等核心问题

## 任务概述
修复当前系统中的四个关键问题：认证超时、并发同步、通知风暴和重复主题获取调用。

## 详细任务清单

### 1. 修复登录"认证超时"问题 (最高优先级)
- [x] **问题分析**：sidepanel.js 中的 onAuthStateChange 监听器无法可靠地接收到后台触发的登录成功事件
- [x] **解决方案**：修改 auth-service.js 中的 signInWithGoogle 函数，采用"手动解析回调URL并调用setSession"的模式
- [x] **具体实现**：确保登录这个核心入口能100%稳定跑通

### 2. 修复"并发同步"与"无故上传"问题
- [x] **问题分析**：SyncService被多次实例化和触发，导致多个同步流程并发执行
- [x] **解决方案**：为sync-service.js中的主同步函数添加"状态锁"
- [x] **具体实现**：在函数入口处检查isSyncing标志，如果正在同步则直接return，在finally块中释放锁

### 3. [x] **修复"通知风暴"与"UI不刷新"问题**
 - [x] **问题分析**：sync-service在下载数据时循环中多次写入存储，导致storage.onChanged被高频触发
 - [x] **解决方案**：重构sync-service.js的下载逻辑，从"循环单次写入"改为"一次性批量写入"
 - [x] **具体实现**：在内存中计算出最终的完整提示词数组后，只调用一次dataService.setAllPrompts()

### 4. [x] **清理重复的"主题获取"调用**
- [x] **问题分析**：应用在某些情况下会反复、高频地发送GET_THEME_MODE消息
- [x] **解决方案**：审查sidepanel.js及相关初始化代码，移除重复调用GET_THEME_MODE消息的逻辑
- [x] **具体实现**：在sidepanel.js的initializeApp函数中，直接使用dataService.getThemeMode()替代消息通信

## 执行顺序
按照优先级从高到低依次执行，确保每个问题都得到彻底解决。