# 标签颜色统一修复计划

## TODO 清单

### [x] 1. 清晰的复现步骤
1. 打开插件主界面，查看提示词卡片上的标签颜色（有蓝色、绿色、紫色等多种颜色）
2. 点击"新建"按钮，进入新建页面
3. 在标签输入区域查看推荐标签的颜色（全部是单一的灰色样式）
4. 对比发现：主界面标签有丰富的颜色分类，而新建/编辑页面的标签颜色单调

### [x] 2. 根源分析 (Root Cause Analysis)

**问题1现象**：新建和编辑页面的待选择标签颜色没有跟随主界面的标签颜色变化
**问题1根本原因**：
1. **主界面标签样式**：使用`uiManager.js`中的`getTagColor()`方法，根据标签名称的哈希值分配颜色类（tag-blue、tag-green等），实现了丰富的颜色分类
2. **新建/编辑页面标签样式**：使用`tagComponentManager.js`中的简单CSS变量样式，所有标签都是统一的灰色外观
3. **技术细节**：两个页面的标签渲染逻辑完全独立，没有共享颜色分配算法

**问题2现象**：新增的标签不显示在新建和编辑提示词的标签区域
**问题2根本原因**：
1. `tagComponentManager.js`的`addTag`方法中调用了`updateAvailableTags`，将新标签立即添加到本地可用标签列表
2. 但是当用户切换页面时，`refreshTagComponent`方法会重新从后台获取所有标签，覆盖了本地的可用标签列表
3. 由于新标签还没有真正保存到数据库中（只有在提示词保存成功后才会保存），所以从后台获取的标签列表中不包含新标签
4. 这导致了数据不一致：本地临时添加的标签被后台的"真实"标签列表覆盖

### [x] 3. 修复方案设计

**问题1修复策略**：统一标签颜色系统，让新建/编辑页面的标签使用与主界面相同的颜色分配逻辑

**问题1具体方案**：
1. **提取颜色分配逻辑**：将`uiManager.js`中的`getTagColor()`方法提取为独立的工具函数
2. **修改标签组件样式**：更新`tagComponentManager.js`中的`renderRecommendedTags()`方法，使用颜色分配算法
3. **保持主题适配**：确保新的颜色系统在明亮和暗黑主题下都能正常工作
4. **统一样式类**：复用现有的CSS颜色类（tag-blue、tag-green等）

**问题2修复策略**：修复标签数据同步逻辑，确保新增标签在页面切换时不会丢失

**问题2具体方案**：
1. **修改addTag方法**：移除`addTag`方法中立即调用`updateAvailableTags`的逻辑
2. **改进refreshTagComponent方法**：在获取后台标签后，合并当前正在编辑的标签
3. **优化标签保存时机**：确保标签只在提示词保存成功后才被添加到全局可用标签列表
4. **保持数据一致性**：避免本地临时标签被后台数据覆盖

**技术实现**：
- 在`tagComponentManager.js`中添加`getTagColor()`方法（复制自`uiManager.js`）
- 修改`renderRecommendedTags()`方法，为每个标签应用对应的颜色类
- 修改`addTag`方法，移除立即更新可用标签的逻辑
- 修改`refreshTagComponent`方法，保留当前正在编辑的标签
- 确保CSS类名与主界面保持一致

### [x] 4. 强制安全检查 (Mandatory Safety Check)

**回归风险评估**：这个修复方案是否可能违反【最高指令 #1: 绝不引入回归】？为什么它100%不会？

**答案**：本方案不会引入回归，因为：
1. **不影响现有功能**：只是修改标签的视觉样式，不改变任何业务逻辑或数据处理
2. **复用成熟代码**：使用的是主界面已经验证过的颜色分配算法，技术风险极低
3. **向后兼容**：不改变任何API接口或数据结构，完全是UI层面的优化
4. **渐进式改进**：只增强视觉效果，不删除或修改现有功能
5. **遵守技术栈契约**：在现有的原生JS技术栈内进行修改，符合【最高指令 #2】

### [x] 5. 详细的修复步骤

#### 步骤1：修复标签显示逻辑（问题2）
1. [x] 修改`tagComponentManager.js`中的`addTag`方法，移除立即调用`updateAvailableTags`的逻辑
2. [x] 修改`appController.js`中的`refreshTagComponent`方法，在获取后台标签后，合并当前正在编辑的标签
3. [x] 确保标签只在提示词保存成功后才被添加到全局可用标签列表

#### 步骤2：提取颜色分配逻辑（问题1）
1. [x] 在`tagComponentManager.js`中添加`getTagColor(tag)`方法
2. [x] 复制`uiManager.js`中的颜色分配算法（已完成完整复制，包括颜色使用记录和智能分配逻辑）

#### 步骤3：修改推荐标签渲染（问题1）
1. [x] 更新`renderRecommendedTags()`方法
2. [x] 为每个推荐标签应用对应的颜色类
3. [x] 移除硬编码的灰色样式

#### 步骤4：修改已选标签渲染（问题1）
1. [x] 更新`renderTags()`方法
2. [x] 为已选标签也应用相同的颜色系统

#### 步骤5：测试验证
1. [x] 测试新增标签在页面切换后是否正确显示
2. [x] 测试标签颜色是否正确分配
3. [x] 测试新建页面标签颜色是否与主界面一致
4. [x] 测试编辑页面标签颜色是否正确
5. [x] 测试明亮/暗黑主题切换是否正常
6. [x] 验证标签交互功能是否正常