# 消息驱动架构重构：获取提示词列表功能

**任务时间**: 2025-01-03 14:30:00  
**任务类型**: 架构重构  
**影响范围**: 只读功能（获取并显示全部提示词列表）  
**技术栈**: 原生JavaScript, Chrome Extension Manifest V3

## 任务背景

当前PromptCraft项目使用UI直接调用数据服务的模式，我们需要将其重构为"UI发送消息，后台处理并响应"的消息驱动架构。本次重构是第一步，只重构"获取并显示全部提示词列表"这一个只读功能，为后续的完整架构升级做准备。

## 核心约束

- ✅ **只修改只读功能**: 绝对不修改任何与"添加"、"编辑"、"删除"、"登录"或"同步"相关的现有代码
- ✅ **保持data-service.js不变**: 数据服务层的功能和代码完全保持不变
- ✅ **最小化修改原则**: 仅修改必要的代码，确保不引入新的安全漏洞或性能问题
- ✅ **向后兼容**: 确保其他功能不受影响

## 详细任务清单

### 1. 后台消息处理器实现

- [x] **1.1 分析background.js现有结构**
  - 查看现有的消息监听器（如果有）
  - 确认dataService的导入和可用性
  - 了解现有的错误处理机制

- [x] **1.2 添加GET_ALL_PROMPTS消息监听器**
  - 在background.js中添加chrome.runtime.onMessage监听器
  - 处理type为'GET_ALL_PROMPTS'的消息
  - 调用dataService.getAllPrompts()获取数据
  - 通过sendResponse异步返回结果
  - 添加完整的错误处理和日志记录

- [x] **1.3 确保消息处理的健壮性**
  - 添加参数验证
  - 实现超时处理
  - 确保异步响应正确返回

### 2. 前端消息发送实现

- [x] **2.1 定位loadUserPrompts函数**
  - 在sidepanel.js中找到loadUserPrompts函数（约第404行）
  - 分析现有实现的逻辑流程
  - 识别需要保留的UI状态管理代码

- [x] **2.2 重构loadUserPrompts函数实现**
  - 保留函数签名：`async function loadUserPrompts(skipLoading = false)`
  - 保留loading状态管理逻辑
  - 替换数据获取方式：使用chrome.runtime.sendMessage({ type: 'GET_ALL_PROMPTS' })
  - 使用await接收返回的提示词数组
  - 保留后续的数据处理和渲染逻辑
  - 保留错误处理和用户提示

- [x] **2.3 确保消息通信的可靠性**
  - 添加消息发送失败的处理
  - 保持与原有错误处理逻辑的一致性
  - 确保用户体验不受影响

### 3. 测试与验证

- [x] **3.1 功能测试**
  - 验证提示词列表能正常加载和显示
  - 测试loading状态的正确显示和隐藏
  - 确认排序功能正常（按创建时间降序）
  - 验证搜索和筛选功能不受影响

- [x] **3.2 错误场景测试**
  - 测试数据加载失败时的错误提示
  - 验证空数据状态的正确处理
  - 确认网络异常时的降级处理

- [x] **3.3 性能验证**
  - 确认加载速度没有明显下降
  - 验证内存使用没有异常增长
  - 测试大量数据时的响应性能

### 4. 代码质量保证

- [x] **4.1 代码审查**
  - 确保代码符合项目的编码规范
  - 验证错误处理的完整性
  - 检查日志记录的适当性

- [x] **4.2 文档更新**
  - 在代码中添加必要的注释
  - 说明消息通信的工作原理
  - 记录重构的技术决策

- [x] **4.3 兼容性确认**
  - 确保其他功能（添加、编辑、删除等）完全不受影响
  - 验证同步功能的正常工作
  - 测试主题切换等UI功能

### 5. 额外修复

- [x] **5.1 视图警告修复**
  - 优化了视图显示检查机制，消除初始化时的误报警告

- [x] **5.2 CSS加载检测**
  - 添加智能CSS加载完成检测，提升用户体验

## 技术实现细节

### 消息通信协议

**请求格式**:
```javascript
{
  type: 'GET_ALL_PROMPTS'
}
```

**响应格式**:
```javascript
{
  success: true,
  data: [...], // 提示词数组
  error: null
}
```

**错误响应格式**:
```javascript
{
  success: false,
  data: null,
  error: "错误信息"
}
```

### 关键代码位置

- **background.js**: 第170行附近添加消息监听器
- **sidepanel.js**: 第404行loadUserPrompts函数需要重构
- **data-service.js**: 保持不变，继续提供getAllPrompts()方法

## 预期效果

1. **架构升级**: 实现UI与数据服务的解耦，为后续完整重构奠定基础
2. **功能保持**: 用户体验完全不变，所有现有功能正常工作
3. **代码质量**: 提高代码的可维护性和可扩展性
4. **性能稳定**: 不引入性能回归，保持原有的响应速度

## 风险控制

- **最小化修改**: 只修改必要的代码，降低引入bug的风险
- **渐进式重构**: 分步骤实施，每步都可以独立验证
- **完整测试**: 确保所有相关功能都经过充分测试
- **回滚准备**: 保留原有代码的备份，必要时可以快速回滚

---

**执行说明**: 本文档创建后，将严格按照数字顺序逐一执行所有任务项，每完成一项将其状态从 `[ ]` 更新为 `[x]`。