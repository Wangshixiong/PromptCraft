# Google登录状态修复 - 测试指导文档

## 测试目标
验证Google登录状态在浏览器重启后能够正确保持，确保"初次握手"机制正常工作。

## 核心测试场景

### 1. 基础登录状态保持测试
**测试步骤：**
1. 打开Chrome浏览器，安装/启用PromptCraft扩展
2. 点击扩展图标，打开侧边栏
3. 点击"使用Google登录"按钮，完成登录流程
4. 确认登录成功（显示用户头像、姓名、邮箱）
5. **关闭整个浏览器**（不是关闭标签页）
6. 重新打开浏览器
7. 点击扩展图标，打开侧边栏

**预期结果：**
- ✅ 侧边栏应该直接显示已登录状态
- ✅ 用户头像、姓名、邮箱信息正确显示
- ✅ 无需重新登录

### 2. 多标签页同步测试
**测试步骤：**
1. 在已登录状态下，打开多个标签页
2. 在每个标签页中打开PromptCraft侧边栏
3. 在其中一个标签页中退出登录
4. 检查其他标签页的登录状态

**预期结果：**
- ✅ 所有标签页应该同步显示退出登录状态
- ✅ 认证状态变化应该实时同步

### 3. 网络异常降级测试
**测试步骤：**
1. 断开网络连接
2. 重启浏览器
3. 打开PromptCraft侧边栏

**预期结果：**
- ✅ 扩展应该正常启动，不会因为网络问题卡死
- ✅ 本地功能（查看、编辑本地提示词）应该正常工作
- ✅ 控制台应该有相应的错误日志，但不影响基本功能

## 调试验证要点

### 控制台日志检查
打开Chrome开发者工具（F12），在Console标签页中查看以下关键日志：

**后台服务日志（background.js）：**
```
PromptCraft: 浏览器启动，开始恢复认证状态...
PromptCraft: 收到GET_AUTH_STATE消息请求
PromptCraft: 当前认证状态: 已登录/未登录
```

**前端初始化日志（sidepanel.js）：**
```
PromptCraft: 正在查询后台认证状态...
PromptCraft: 后台认证状态查询结果: 已登录/未登录
PromptCraft: 成功恢复用户会话: user@example.com
```

### 存储状态检查
在开发者工具中检查Chrome存储：
1. 打开Application标签页
2. 展开Storage → Local Storage
3. 查看扩展相关的存储项
4. 确认认证信息已正确保存

## 边界情况测试

### 1. 快速重启测试
- 连续多次快速关闭/打开浏览器
- 验证认证状态恢复的稳定性

### 2. 会话过期测试
- 等待较长时间（如24小时）后重启浏览器
- 验证过期会话的处理逻辑

### 3. 扩展重新加载测试
- 在chrome://extensions/页面重新加载扩展
- 验证认证状态是否正确恢复

## 性能验证

### 启动速度测试
- 测量从打开侧边栏到显示登录状态的时间
- 应该在1-2秒内完成状态恢复

### 资源消耗测试
- 检查内存使用情况
- 确认没有内存泄漏或异常资源占用

## 故障排除指南

### 如果登录状态仍然丢失：
1. 检查控制台是否有错误日志
2. 确认Supabase服务是否正常
3. 检查Chrome存储中的认证数据
4. 尝试清除扩展数据后重新登录

### 如果出现认证错误：
1. 检查网络连接
2. 确认Google OAuth配置是否正确
3. 检查Supabase项目设置
4. 查看详细的错误日志信息

## 测试完成标准

✅ **核心功能正常**：浏览器重启后登录状态正确保持  
✅ **同步机制正常**：多标签页认证状态实时同步  
✅ **错误处理正常**：网络异常时不影响基本功能  
✅ **性能表现良好**：状态恢复速度快，资源消耗合理  
✅ **日志信息完整**：关键操作有清晰的日志记录  

## 注意事项

- 测试时请使用真实的Google账号进行登录
- 建议在不同的网络环境下进行测试
- 如发现问题，请保存完整的控制台日志用于分析
- 测试完成后，可以选择退出登录以保护隐私

---

**文档创建时间：** 2025-01-18 14:30:00  
**对应修复版本：** Google登录状态丢失问题修复  
**测试负责人：** 开发团队