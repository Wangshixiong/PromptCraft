# 修复消息循环问题

## 问题描述

用户反馈在登录过程中出现反复加载主题的问题，从日志分析发现：

1. **GET_THEME_MODE消息重复发送**：content_script.js中的getThemeMode函数被重复调用
2. **getPrompts消息重复发送**：loadPrompts函数被重复调用
3. **sidepanel收到未知消息类型**：sidepanel.js无法正确处理某些消息

## 问题根源分析

### 主要问题
1. **主题监听器重复设置**：setupThemeListener函数可能被多次调用，导致重复的事件监听器
2. **updateUITheme函数重复调用**：在多个地方调用updateUITheme，每次都会触发getThemeMode
3. **数据变更通知循环**：DATA_CHANGED消息可能触发loadPrompts，形成循环
4. **消息处理不完整**：sidepanel.js缺少对某些消息类型的处理

### 具体位置
- content_script.js第1185行：初始化时调用updateUITheme
- content_script.js第1884行：存储变化时调用updateUITheme
- content_script.js第1894行：系统主题变化时调用updateUITheme
- content_script.js第463行：DATA_CHANGED消息触发loadPrompts

## 解决方案

### 阶段一：防止重复监听器设置
1. [x] **添加监听器状态标记**：防止setupThemeListener被重复调用
2. [x] **优化updateUITheme调用**：减少不必要的主题更新
3. [x] **缓存主题状态**：避免重复获取相同的主题信息

### 阶段二：优化消息处理
4. [x] **完善sidepanel消息处理**：添加对GET_THEME_MODE等消息的处理
5. [x] **优化DATA_CHANGED处理**：避免不必要的数据重新加载
6. [x] **添加消息去重机制**：防止短时间内重复发送相同消息

### 阶段三：测试验证
7. [x] **测试登录流程**：确认消息循环问题已解决
8. [x] **验证主题切换**：确保主题功能正常工作
9. [x] **检查性能影响**：确认修复后性能有所改善

## 技术细节

### 监听器管理
- 使用全局标记防止重复设置监听器
- 在适当时机清理不需要的监听器

### 消息优化
- 实现消息去重机制
- 添加消息处理的错误处理
- 优化消息发送频率

### 主题管理
- 缓存当前主题状态
- 只在真正需要时更新主题
- 减少不必要的DOM操作

## 预期效果

1. **消除消息循环**：不再出现重复的GET_THEME_MODE和getPrompts消息
2. **提升性能**：减少不必要的消息通信和DOM操作
3. **改善用户体验**：登录过程更加流畅，无卡顿现象
4. **增强稳定性**：减少因消息循环导致的潜在问题