# 插件重新加载错误修复 - Bug修复任务

## TODO 清单

### [ ] 清晰的复现步骤
1. 打开Chrome扩展管理页面
2. 连续快速点击「重新加载」按钮（间隔小于1秒）
3. 观察到以下错误：
   - `chrome.storage.local.get 错误: [object Object]`
   - `恢复同步状态失败: Error: 存储读取失败: No SW`
   - `Error handling response: TypeError: Cannot read properties of undefined (reading 'sb-uwgxhtrbixsdabjvuuaj-auth-token')`
   - `Unchecked runtime.lastError: No SW`
   - `Uncaught NetworkError: Failed to execute 'importScripts' on 'WorkerGlobalScope'`

### [ ] 根源分析 (Root Cause Analysis)

**现象分析：**
- 错误只在连续快速重新加载时出现，单次重新加载正常
- 主要涉及Service Worker生命周期和chrome.storage API
- 认证token读取失败，表明存储访问时机问题

**根本原因：**
1. **Service Worker竞态条件**：连续重新加载导致多个Service Worker实例同时存在，造成资源竞争
2. **存储访问时机错误**：在Service Worker完全初始化前就尝试访问chrome.storage
3. **importScripts竞态**：多个Worker同时加载相同脚本文件，导致加载冲突
4. **认证状态恢复过早**：在存储服务准备就绪前就尝试读取认证token

**技术细节：**
- Chrome Extension Manifest V3的Service Worker有严格的生命周期管理
- chrome.storage API在Worker未完全激活时可能返回"No SW"错误
- 连续重新加载会导致前一个Worker还未完全销毁，新Worker就开始初始化

### [ ] 修复方案设计

**核心策略：添加Service Worker就绪检查和重试机制**

1. **Service Worker就绪检查**：
   - 在background.js开头添加Worker状态检查
   - 确保所有存储操作都在Worker完全就绪后执行

2. **存储访问重试机制**：
   - 为data-service.js的存储操作添加重试逻辑
   - 检测"No SW"错误并自动重试

3. **认证状态恢复延迟**：
   - 将restoreAuthState()调用延迟到存储服务完全初始化后
   - 添加存储可用性检查

4. **importScripts防重复加载**：
   - 添加脚本加载状态检查，避免重复导入

### [ ] 强制安全检查 (Mandatory Safety Check)

**回归风险评估**：本修复方案不会引入回归，因为：

1. **只添加保护性代码**：所有修改都是添加检查和重试机制，不改变现有业务逻辑
2. **向后兼容**：修复只在检测到错误时生效，正常情况下不影响现有流程
3. **渐进增强**：采用优雅降级策略，即使新的检查机制失败，也会回退到原有逻辑
4. **最小化影响**：修改集中在错误处理和初始化检查，不涉及核心功能代码
5. **Chrome Extension最佳实践**：所有修改都遵循Manifest V3的官方建议和最佳实践

**测试验证**：
- 单次重新加载功能正常（现有功能不受影响）
- 连续重新加载不再出现错误（问题得到解决）
- 所有核心功能（提示词管理、认证、同步）保持正常

### [ ] 详细的修复步骤

1. **修改background.js**：
   - 添加Service Worker就绪检查函数
   - 延迟认证状态恢复的调用时机
   - 添加importScripts错误处理

2. **修改data-service.js**：
   - 为_getFromStorage方法添加重试机制
   - 检测"No SW"错误并自动重试
   - 添加存储可用性检查

3. **修改auth-service.js**：
   - 为token读取添加存储就绪检查
   - 添加认证状态恢复的防护机制

4. **测试验证**：
   - 测试单次重新加载
   - 测试连续快速重新加载
   - 验证所有核心功能正常