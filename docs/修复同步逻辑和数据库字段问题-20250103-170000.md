# 修复同步逻辑和数据库字段问题

## 问题分析

### 问题1：source字段导致的更新失败
- **现象**：编辑提示词后云端没有立刻更新，控制台报错 'source' 列不存在
- **根因**：本地数据包含 `source` 字段，但云端数据库没有此字段
- **影响**：用户编辑提示词无法同步到云端

### 问题2：登录后本地数据被清空
- **现象**：退出登录后在云端添加数据，再次登录时本地列表被清空
- **根因**：程序依赖本地存储的 `migration_completed` 标记判断用户状态，不够可靠
- **影响**：用户数据丢失，体验极差

## 解决方案

### 方案1：source字段处理

**选项A：在云端数据库添加source字段（推荐）**
- 优点：保持数据完整性，便于后续功能扩展
- 缺点：需要修改数据库结构
- 实现：在Supabase中为prompts表添加source列

**选项B：在同步时过滤source字段**
- 优点：无需修改数据库
- 缺点：数据不完整，可能影响后续功能
- 实现：修改updatePrompt方法过滤本地专用字段

### 方案2：用户状态判断优化

**核心思路：直接查询云端数据来判断用户状态**
- 移除对本地 `migration_completed` 标记的依赖
- 登录时直接查询云端是否有该用户的数据
- 根据云端数据情况决定是否需要迁移本地数据

## 任务清单

### 阶段一：source字段问题修复
1. [x] **分析source字段的必要性**：确认source字段是否为核心功能必需
2. [x] **选择解决方案**：根据分析结果选择添加数据库字段或过滤字段的方案
3. [x] **实现修复**：根据选择的方案进行代码修改
4. [ ] **测试验证**：确保编辑提示词能正常同步

### 阶段二：用户状态判断优化
5. [x] **分析现有登录流程**：查看当前的用户状态判断逻辑
6. [x] **设计新的判断机制**：基于云端数据查询的用户状态判断
7. [x] **重构登录逻辑**：移除对本地标记的依赖，改为云端查询
8. [x] **实现数据合并策略**：处理本地数据与云端数据的合并逻辑
9. [ ] **测试完整流程**：验证登录、退出、再登录的完整场景

### 阶段三：整体测试与优化
10. [ ] **端到端测试**：测试所有同步场景
11. [ ] **性能优化**：确保修改不影响应用性能
12. [ ] **文档更新**：更新相关技术文档

## 技术细节

### source字段的作用
- 标记数据来源：`default_template`（默认模板）、`user_created`（用户创建）
- 用于数据迁移和管理逻辑
- 帮助区分不同类型的提示词

### 新的用户状态判断逻辑
```javascript
// 伪代码示例
async function checkUserDataStatus(userId) {
    // 直接查询云端数据
    const cloudData = await queryCloudData(userId);
    
    if (cloudData.length > 0) {
        // 用户在云端有数据，是老用户
        return 'existing_user';
    } else {
        // 用户在云端无数据，可能是新用户或需要迁移
        const localData = await getLocalData();
        if (localData.length > 0) {
            return 'needs_migration';
        } else {
            return 'new_user';
        }
    }
}
```

## 预期效果

1. **编辑同步正常**：用户编辑提示词后能立即同步到云端
2. **登录体验优化**：登录后不会丢失本地或云端数据
3. **数据一致性**：本地和云端数据保持一致
4. **用户体验提升**：消除数据丢失的风险