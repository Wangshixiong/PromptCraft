# 数据管理功能重构：清空与导入

## 任务概述
将 `sidepanel.js` 中的"清空所有数据"和"从JSON文件导入"功能重构为消息驱动模式。

## 核心约束
- **安全第一**：只修改清空和导入相关的逻辑，不影响 authService、syncService
- **功能完整性**：保持现有的合并、去重、更新逻辑不变
- **用户体验**：保持相同的操作反馈和提示信息

## 详细计划

### 1. 代码分析与定位
- [x] **定位清空功能**：找到 `sidepanel.js` 中的 `clearAllData` 函数
- [x] **定位导入功能**：找到 `sidepanel.js` 中的 `handleFileImport` 函数
- [x] **分析现有逻辑**：理解导入时的合并、去重、更新策略

### 2. Background.js 消息处理扩展
- [x] **添加 CLEAR_ALL_PROMPTS 处理**：调用 `dataService.clearAllPrompts()`
- [x] **添加 IMPORT_PROMPTS 处理**：
  - [x] 接收 `importedPrompts` 数组
  - [x] 获取现有数据 `dataService.getAllPrompts()`
  - [x] 执行合并逻辑（去重、更新策略）
  - [x] 保存最终数据 `dataService.setAllPrompts()`
  - [x] 返回操作结果（新增数、更新数）
- [x] **统一错误处理**：确保所有操作都有完整的错误处理

### 3. Sidepanel.js 消息通信重构
- [x] **重构 clearAllData 函数**：
  - [x] 将 `dataService.clearAllPrompts()` 替换为消息通信
  - [x] 保持现有的确认弹窗和成功提示
- [x] **重构 handleFileImport 函数**：
  - [x] 移除 `dataService.getAllPrompts()` 和 `dataService.setAllPrompts()` 调用
  - [x] 将合并逻辑迁移到 background.js
  - [x] 通过消息发送 `importedPrompts` 数组
  - [x] 根据返回结果显示操作反馈
- [x] **移除手动刷新调用**：依赖 `chrome.storage.onChanged` 自动刷新

### 4. 功能测试与验证
- [x] **清空功能测试**：确认清空操作正常工作
- [x] **导入功能测试**：测试JSON文件导入和合并逻辑
- [x] **错误处理测试**：验证各种异常情况的处理
- [x] **UI自动刷新测试**：确认操作后界面自动更新

### 5. 文档更新与完成确认
- [x] **更新任务状态**：标记所有子任务为已完成
- [x] **功能验收**：请求用户进行最终测试

## 技术实现要点

### 消息格式设计
```javascript
// 清空数据
{ type: 'CLEAR_ALL_PROMPTS' }

// 导入数据
{ 
  type: 'IMPORT_PROMPTS', 
  payload: {
    importedPrompts: [...] // 从文件解析的提示词数组
  }
}
```

### 响应格式设计
```javascript
// 清空响应
{ success: true }

// 导入响应
{ 
  success: true, 
  data: {
    addedCount: 5,
    updatedCount: 3,
    total: 8
  }
}
```

### 合并策略保持
- 同名提示词：更新现有内容
- 新提示词：添加到列表开头
- 生成新的 UUID 和时间戳
- 保持 `is_deleted: false` 状态

## 预期效果
1. **架构统一**：所有数据操作都通过消息驱动
2. **性能优化**：利用 `chrome.storage.onChanged` 实现高效的 UI 自动更新
3. **错误处理增强**：统一的错误处理和用户反馈
4. **代码解耦**：UI 层与数据层完全分离