# 手动同步失败诊断指南

## 问题描述
用户反馈：登录时同步成功，但手动点击同步按钮时失败。

## 诊断步骤

### 1. 开启开发者工具
1. 打开Chrome扩展管理页面 `chrome://extensions/`
2. 找到"Prompt管理助手"扩展
3. 点击"详细信息"
4. 点击"检查视图: sidepanel.html"
5. 在开发者工具中切换到"Console"标签页

### 2. 重现问题
1. 确保已登录状态
2. 点击手动同步按钮
3. 观察控制台输出的错误信息

### 3. 关键日志信息
查找以下关键日志：

#### 同步开始日志
```
同步开始 - 用户信息: {
  userId: "xxx",
  email: "xxx@xxx.com",
  sessionValid: true/false,
  sessionExpiry: "2024-xx-xx"
}
```

#### 网络连接测试
```
网络连接测试成功
```
或
```
网络连接测试失败: [错误信息]
```

#### Supabase错误详情
```
Supabase错误详情: {
  code: "xxx",
  message: "xxx",
  details: "xxx",
  hint: "xxx"
}
```

### 4. 常见错误类型及解决方案

#### 4.1 会话过期错误
**错误信息**: "用户会话已过期，请重新登录"
**解决方案**: 
1. 退出登录
2. 重新登录
3. 再次尝试同步

#### 4.2 网络连接错误
**错误信息**: "网络连接失败" 或 "网络连接异常"
**可能原因**:
- 网络连接不稳定
- Supabase服务暂时不可用
- 防火墙或代理设置问题

**解决方案**:
1. 检查网络连接
2. 稍后重试
3. 检查防火墙设置

#### 4.3 权限错误
**错误信息**: 包含"permission"、"unauthorized"等关键词
**解决方案**:
1. 重新登录以刷新权限
2. 检查账户状态

#### 4.4 数据格式错误
**错误信息**: 包含"invalid"、"format"等关键词
**解决方案**:
1. 清理本地数据缓存
2. 重新同步

### 5. 登录同步 vs 手动同步的差异

#### 登录同步特点
- 在用户刚登录时触发
- 此时会话状态是最新的
- 网络连接刚刚建立
- 用户权限刚刚验证

#### 手动同步特点
- 在用户主动触发时执行
- 可能距离登录已有一段时间
- 会话可能已接近过期
- 网络状态可能已变化

### 6. 预防措施

1. **定期刷新会话**: 在长时间使用后重新登录
2. **网络检查**: 确保网络连接稳定
3. **及时更新**: 保持扩展版本最新

### 7. 收集诊断信息

如果问题持续存在，请收集以下信息：

1. **完整的控制台错误日志**
2. **操作步骤记录**
3. **网络环境信息**（是否使用代理、VPN等）
4. **浏览器版本信息**
5. **扩展版本信息**

### 8. 临时解决方案

如果手动同步持续失败，可以尝试：

1. **重新登录**: 退出后重新登录
2. **重启浏览器**: 完全关闭浏览器后重新打开
3. **清理缓存**: 清理浏览器缓存和扩展数据
4. **网络切换**: 尝试切换网络环境

## 修复记录

### 已实施的诊断增强
1. 添加了详细的错误日志记录
2. 增加了会话状态检查
3. 添加了网络连接测试
4. 增强了Supabase错误信息输出

### 下一步计划
1. 根据用户反馈的具体错误信息进行针对性修复
2. 考虑添加自动会话刷新机制
3. 优化错误提示的用户友好性