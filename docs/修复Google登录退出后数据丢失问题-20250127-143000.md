# 修复Google登录退出后数据丢失问题

## 问题描述
1. **问题现象1**: 打开插件侧边栏 → 点击设置 → Google登录 → 登录成功后点击退出 → 关闭侧边栏 → 重新打开侧边栏 → 提示词列表被清空（显示空空如也）
2. **问题现象2**: 在上述操作后 → 关闭浏览器 → 重新打开侧边栏 → 提示词列表显示内容，但仅显示本地默认提示词，网络同步的内容不显示

## 问题根本原因分析

### 🔍 **核心问题**: `auth-service.js` 第256行的 `chrome.storage.local.clear()` 导致数据丢失

**日志分析结果**:

**控制台日志1 (登录→同步→退出→重开)**:
- 登录成功，同步了9条数据 (本地5条 + 云端6条)
- 退出登录时调用 `chrome.storage.local.clear()` **清空了所有本地存储**
- 重开侧边栏时，`获取所有提示词: 0 条` - 数据完全丢失

**控制台日志2 (重启浏览器)**:
- 重启后 `hasData flag: false`，触发 "First time installation" 流程
- 重新加载默认的5条提示词
- 之前同步的6条云端数据永久丢失

**代码问题定位**:
1. **auth-service.js:256** - `await chrome.storage.local.clear();` 过度清理
2. **background.js:30** - 重启后错误地重置 `hasData=false`
3. **缺乏数据保护机制** - 没有区分认证数据和用户数据

### 存储键分类分析

**需要保留的用户数据键**:
- `prompts` - 用户的个人提示词
- `themeMode` - 用户主题设置
- `promptcraft_has_data` - 数据状态标志
- `default_templates_loaded` - 默认模板加载状态
- `schema_version` - 数据模式版本

**需要清理的认证相关键**:
- `sb-uwgxhtrbixsdabjvuuaj-auth-token` - Supabase认证令牌(推测)
- `last_sync_time` - 最后同步时间
- `sync_status` - 同步状态
- `migration_completed` - 迁移完成标记
- `sync_queue` - 同步队列
- `conflict_log` - 冲突解决日志

## 修复任务清单

1. [x] **分析控制台日志**: 已定位到 `chrome.storage.local.clear()` 为根本原因
2. [x] **分析代码逻辑**: 已确认退出登录时过度清理本地存储
3. [x] **确定存储键分类**: 区分认证数据和用户数据的存储键
4. [x] **修复退出登录逻辑**: 替换 `chrome.storage.local.clear()` 为选择性清理
5. [x] **实现选择性数据清理**: 只清理认证相关数据，保留用户提示词数据
6. [x] **修复初始化逻辑**: 防止重启后错误触发 "首次安装" 流程
7. [x] **添加数据保护机制**: 确保用户数据不会被意外清理
8. [ ] **测试验证**: 完整测试登录→同步→退出→重开→重启的流程

## 预期修复目标
- 退出登录后，本地数据（包括同步获得的数据）应该完整保留
- 重启浏览器后，所有本地数据应该正确恢复显示
- 用户的数据安全得到充分保障，避免意外丢失