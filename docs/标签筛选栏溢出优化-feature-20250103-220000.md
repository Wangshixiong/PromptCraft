# 标签筛选栏溢出优化功能开发规划

**任务类型**: `new_feature`  
**创建时间**: 2025-01-03 22:00:00  
**开发者**: AI Assistant  

## TODO 清单

### 1. [x] 需求澄清与用户故事

**用户故事**: 
As a 提示词管理工具用户, I want 标签筛选栏能够优雅地处理大量标签, so that 我可以方便地浏览和筛选所有标签，而不会因为标签过多导致界面溢出或无法访问某些标签。

**具体需求**:
- 当标签数量较少时，正常显示所有标签按钮
- 当标签数量过多导致溢出时，显示部分标签 + "更多"按钮
- 点击"更多"按钮时，展开显示所有标签或提供下拉菜单
- 保持现有的筛选功能不变
- 适配明暗双主题

**期望效果**:
```
正常状态: [全部] [AI绘画] [产品经理] [学习搭档]
溢出状态: [全部] [AI绘画] [产品经理] [...更多]
展开状态: [全部] [AI绘画] [产品经理] [学习搭档] [编程助手] [写作工具] [收起]
```

### 2. [x] 技术方案设计

**核心技术栈**: 原生JavaScript + CSS (遵循【最高指令 #2】的技术栈契约)

**设计方案**:

1. **溢出检测机制**:
   - 使用 `scrollWidth` vs `clientWidth` 检测容器是否溢出
   - 动态计算可显示的标签数量
   - 实时监听窗口大小变化

2. **UI交互设计**:
   - 添加"更多"按钮，使用Font Awesome图标，样式与现有标签按钮保持一致
   - 支持展开/收起状态切换
   - **采用方案B**: 点击"更多"按钮直接平铺展开所有标签，不使用下拉菜单
   - 展开时显示所有标签，并将"更多"按钮变为"收起"按钮

3. **数据结构**:
   ```javascript
   {
     allTags: ['全部', 'AI绘画', '产品经理', ...], // 所有标签
     visibleTags: ['全部', 'AI绘画', ...], // 当前可见标签
     isExpanded: false, // 是否展开状态
     maxVisibleCount: 0 // 最大可显示标签数
   }
   ```

4. **核心函数设计**:
   - `calculateVisibleTags()`: 计算可显示的标签数量
   - `renderFilterButtons()`: 重构现有的按钮渲染逻辑
   - `toggleExpanded()`: 切换展开/收起状态
   - `handleResize()`: 处理窗口大小变化

**技术栈契约遵守说明**: 
此方案完全在现有的原生JavaScript技术栈内实现，不引入Svelte等新技术。所有新增功能都是对现有 `uiManager.js` 中 `updateFilterButtons()` 方法的增强，保持了技术栈的一致性。

### 3. [x] 详细的开发步骤

#### 步骤1: 扩展uiManager.js的标签管理功能 ✅
- ✅ 在 `uiManager.js` 中添加标签溢出检测逻辑
- ✅ 重构 `updateFilterButtons()` 方法，支持动态显示/隐藏标签
- ✅ 添加"更多"和"收起"按钮的创建和事件处理

#### 步骤2: 增强CSS样式支持 ✅
- ✅ 在 `components.css` 中添加"更多"按钮的样式
- ✅ 确保展开状态下的标签容器样式正确
- ✅ 适配明暗双主题

#### 步骤3: 集成到appController.js ✅
- ✅ 标签筛选功能与新的UI逻辑完全兼容
- ✅ 展开/收起状态下的筛选逻辑正常工作
- ✅ 无需额外的窗口大小监听（CSS自适应处理）

#### 步骤4: 问题修复与优化 ✅
- ✅ **关键修复**: 改为向下换行展开，区别于横向滚动
- ✅ **收起功能**: 展开状态下可正常收起
- ✅ **视觉效果**: 展开时标签占用多行，明显的交互反馈
- ✅ **主题适配**: 明暗主题切换正常

### 4. [x] 强制安全检查 (Mandatory Safety Check)

**回归风险评估**: 这个新功能方案是否可能违反【最高指令 #1: 绝不引入回归】？为什么它100%不会？

**答案**: 本方案不会引入回归，原因如下：
1. **功能增强而非替换**: 我们是在现有的 `updateFilterButtons()` 方法基础上进行增强，而不是完全重写
2. **向后兼容**: 当标签数量较少时，显示效果与现有完全一致
3. **核心逻辑保持不变**: 标签筛选的核心逻辑 (`handleFilter` 方法) 完全不变
4. **渐进式增强**: 新功能只在检测到溢出时才激活，不影响正常使用场景
5. **CSS隔离**: 新增的CSS样式使用独立的类名，不会影响现有样式
6. **事件处理兼容**: 新的"更多"按钮使用与现有标签按钮相同的事件处理模式

**技术栈契约遵守**: 完全在原生JavaScript技术栈内实现，符合【最高指令 #2】要求。

## 预期交付物

1. **修改的文件**:
   - `src/sidepanel/uiManager.js` - 增强标签按钮渲染逻辑
   - `src/sidepanel/css/components.css` - 新增"更多"按钮样式
   - `src/sidepanel/appController.js` - 添加窗口大小监听

2. **新增功能**:
   - 智能标签溢出检测
   - "更多"/"收起"按钮交互
   - 响应式标签显示
   - 明暗主题适配

3. **保持不变**:
   - 现有标签筛选逻辑
   - 标签按钮样式和交互
   - 数据结构和API接口

## 风险评估

**低风险**: 此功能为纯UI增强，不涉及数据存储或核心业务逻辑修改，回归风险极低。

**测试重点**: 
- 不同标签数量下的显示效果
- 窗口大小变化的响应性
- 筛选功能的正确性
- 主题切换的兼容性