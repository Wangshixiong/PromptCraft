# Bug修复计划：登录同步状态显示异常

**Bug描述**: 登录后，登录状态页显示的是"尚未同步"，没有显示最后一次同步时间

**创建时间**: 2024-12-28 16:00:00

## 阶段一：问题复现与初步诊断

### TODO清单

#### 1. Bug复现步骤定义
- [ ] 1.1 打开浏览器插件sidepanel页面
- [ ] 1.2 确认当前登录状态
- [ ] 1.3 如未登录，执行登录操作
- [ ] 1.4 登录成功后，观察同步状态显示区域
- [ ] 1.5 截图记录当前显示内容
- [ ] 1.6 检查控制台是否有相关错误日志

#### 2. 初步假设
- [ ] 2.1 **假设A**: 同步状态数据获取失败 - `getSyncStatus()` 或 `getLastSyncTime()` 方法返回空值
- [ ] 2.2 **假设B**: UI渲染逻辑错误 - 同步状态数据正确但UI显示逻辑有问题
- [ ] 2.3 **假设C**: 登录后同步流程未正确触发 - 登录成功后没有执行同步操作
- [ ] 2.4 **假设D**: 数据存储问题 - 同步时间数据未正确保存到chrome.storage

## 阶段二：自动化诊断策略

### 动态测试计划（Browser MCP）

#### 3. 登录状态验证
- [ ] 3.1 使用Browser MCP导航到插件sidepanel页面
- [ ] 3.2 截图当前页面状态
- [ ] 3.3 检查登录状态显示区域
- [ ] 3.4 获取控制台日志，查找登录相关信息

#### 4. 同步状态数据检查
- [ ] 4.1 在控制台执行 `chrome.storage.local.get(['lastSyncTime', 'syncStatus'])` 检查存储数据
- [ ] 4.2 在控制台执行 `dataService.getLastSyncTime()` 检查方法返回值
- [ ] 4.3 在控制台执行 `dataService.getSyncStatus()` 检查同步状态
- [ ] 4.4 记录所有返回值和错误信息

#### 5. UI渲染逻辑验证
- [ ] 5.1 检查sidepanel.html中同步状态相关的DOM元素
- [ ] 5.2 在控制台检查相关DOM元素的内容和属性
- [ ] 5.3 验证JavaScript中更新同步状态的函数是否被正确调用

#### 6. 同步流程追踪
- [ ] 6.1 手动触发同步操作（如果有同步按钮）
- [ ] 6.2 监控同步过程中的控制台日志
- [ ] 6.3 验证同步完成后状态是否正确更新
- [ ] 6.4 检查同步时间是否正确保存

## 阶段三：静态代码分析

#### 7. 关键文件分析
- [ ] 7.1 分析 `sidepanel.js` 中同步状态显示相关代码
- [ ] 7.2 分析 `data-service.js` 中 `getLastSyncTime()` 和 `getSyncStatus()` 方法
- [ ] 7.3 分析 `sync-service.js` 中同步完成后的状态更新逻辑
- [ ] 7.4 分析 `sidepanel.html` 中同步状态显示的DOM结构

#### 8. 数据流追踪
- [ ] 8.1 追踪登录成功后的数据流：登录 -> 同步触发 -> 状态更新 -> UI显示
- [ ] 8.2 检查每个环节的错误处理机制
- [ ] 8.3 验证数据存储和读取的一致性

## 阶段四：问题定位与修复

#### 9. 根因分析
- [ ] 9.1 基于收集的证据，确定问题的根本原因
- [ ] 9.2 制定最小化影响的修复方案
- [ ] 9.3 评估修复方案对现有功能的影响

#### 10. 修复实施
- [ ] 10.1 实施代码修复
- [ ] 10.2 添加必要的日志记录以便后续调试
- [ ] 10.3 确保修复不影响其他功能

#### 11. 验证测试
- [ ] 11.1 重新执行Bug复现步骤
- [ ] 11.2 验证修复后同步状态显示正确
- [ ] 11.3 测试相关功能是否正常工作
- [ ] 11.4 检查是否引入新的问题

## 预期证据收集

1. **截图证据**: 登录前后的页面状态对比
2. **控制台日志**: 登录、同步相关的所有日志信息
3. **存储数据**: chrome.storage中同步相关数据的实际值
4. **网络请求**: 同步过程中的API调用记录
5. **DOM状态**: 同步状态显示区域的实际DOM内容

## 关键文件清单

- `src/sidepanel/sidepanel.html` - UI结构
- `src/sidepanel/sidepanel.js` - UI逻辑和状态显示
- `src/utils/data-service.js` - 数据服务，包含同步状态相关方法
- `src/utils/sync-service.js` - 同步服务，负责同步操作和状态更新
- `src/utils/auth-service.js` - 认证服务，登录相关逻辑

---

**注意**: 本计划将通过Browser MCP服务进行自动化测试，确保收集到准确的运行时证据。