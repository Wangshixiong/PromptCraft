# 数据写入重构：消息驱动模式迁移

## 任务概述
将 `sidepanel.js` 中的所有数据写入功能（添加、更新、删除提示词）重构为消息驱动模式。UI 不再直接调用 `dataService`，而是向 `background.js` 发送命令。

## 核心约束
- **增量式重构第二步**：基于第一步（数据读取）的成功验证
- **严格限定范围**：仅迁移 `addPrompt`、`updatePrompt`、`deletePrompt` 三个功能
- **保持其他逻辑不变**：不修改 `authService` 或 `syncService` 的任何逻辑
- **利用现有机制**：使用已有的 `chrome.storage.onChanged` 自动刷新 UI

## 任务清单

### 1. 代码分析与定位
- [x] **定位数据写入函数**：在 `sidepanel.js` 中找到调用 `dataService.addPrompt`、`dataService.updatePrompt`、`dataService.deletePrompt` 的位置
- [x] **分析调用上下文**：了解这些函数在 `savePrompt` 和 `deletePrompt` 事件处理函数中的使用方式
- [x] **确认现有消息处理**：检查 `background.js` 中现有的消息监听器结构

### 2. Background.js 消息处理扩展
- [x] **添加 ADD_PROMPT 处理**：在 `chrome.runtime.onMessage` 监听器中添加对 `'ADD_PROMPT'` 消息的处理
- [x] **添加 UPDATE_PROMPT 处理**：添加对 `'UPDATE_PROMPT'` 消息的处理
- [x] **添加 DELETE_PROMPT 处理**：添加对 `'DELETE_PROMPT'` 消息的处理
- [x] **统一错误处理**：确保所有操作都有完整的成功/失败状态返回

### 3. Sidepanel.js 消息通信重构
- [x] **重构 savePrompt 函数**：将 `dataService.addPrompt` 和 `dataService.updatePrompt` 调用替换为消息通信
- [x] **重构 deletePrompt 函数**：将 `dataService.deletePrompt` 调用替换为消息通信
- [x] **移除手动刷新调用**：删除 `sendMessage` 成功后的 `loadUserPrompts()` 调用（利用 `chrome.storage.onChanged` 自动刷新）
- [x] **保持错误处理**：确保消息通信的错误处理与原有逻辑一致

### 4. 功能验证与测试
- [ ] **验证添加功能**：测试新增提示词是否正常工作
- [ ] **验证更新功能**：测试编辑提示词是否正常工作
- [ ] **验证删除功能**：测试删除提示词是否正常工作
- [ ] **验证自动刷新**：确认操作后 UI 自动更新，无需手动刷新
- [ ] **验证错误处理**：测试各种错误情况的处理

### 5. 文档更新与总结
- [ ] **更新任务状态**：将完成的任务在本文档中标记为已完成
- [ ] **记录重构效果**：总结消息驱动模式的优势和改进
- [ ] **为下一步做准备**：为后续可能的 `authService` 和 `syncService` 重构做准备

## 技术实现细节

### 消息类型定义
```javascript
// 添加提示词
{ type: 'ADD_PROMPT', payload: newPrompt }

// 更新提示词
{ type: 'UPDATE_PROMPT', payload: updatedPrompt }

// 删除提示词
{ type: 'DELETE_PROMPT', payload: promptId }
```

### 响应格式
```javascript
// 成功响应
{ success: true }

// 失败响应
{ success: false, error: error.message }
```

## 预期效果
1. **架构清晰**：UI 层与数据层完全解耦，通过消息通信
2. **性能优化**：利用 `chrome.storage.onChanged` 实现高效的 UI 自动更新
3. **错误隔离**：数据操作错误不会直接影响 UI 层
4. **扩展性强**：为后续功能扩展奠定良好的消息驱动架构基础
5. **增量安全**：保持其他功能不变，降低重构风险

---

**创建时间**：2025-01-03 15:15:00  
**任务类型**：增量式重构 - 数据写入操作  
**预计完成时间**：30-45分钟