# PromptCraft é¡¹ç›®å‡½æ•°è°ƒç”¨é€»è¾‘åˆ†æ

**åˆ›å»ºæ—¶é—´**: 2025-06-29  
**æœ€åæ›´æ–°**: 2024-12-28 (æ‰‹åŠ¨åŒæ­¥å¤±è´¥Bugä¿®å¤)  
**åˆ†æç›®çš„**: è®°å½•é¡¹ç›®ä¸­å…³é”®æ•°æ®æµå’Œå‡½æ•°è°ƒç”¨å…³ç³»ï¼Œä¾¿äºåç»­ç»´æŠ¤å’Œè°ƒè¯•

## v1.3.0 æ¶æ„é‡æ„è¯´æ˜

æœ¬ç‰ˆæœ¬å®Œæˆäº†JavaScriptä»£ç çš„å…¨é¢é‡æ„ï¼Œä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š

### ğŸ”§ **ä»£ç æ¨¡å—åŒ–**
- å°†`sidepanel.js`ä»502è¡Œç²¾ç®€åˆ°323è¡Œ
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¿ç§»åˆ°`appController.js`
- å®ç°æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼šUIæ¸²æŸ“ vs ä¸šåŠ¡é€»è¾‘

### ğŸ“ **æ–‡ä»¶ç»“æ„ä¼˜åŒ–**
- `sidepanel.js`: ä¸“æ³¨äºDOMæ“ä½œå’Œäº‹ä»¶ç»‘å®š
- `appController.js`: å¤„ç†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®æ“ä½œ
- `uiManager.js`: ç»Ÿä¸€ç®¡ç†UIç»„ä»¶å’Œäº¤äº’

### ğŸ› **è¯­æ³•é”™è¯¯ä¿®å¤**
- ä¿®å¤å‡½æ•°å®šä¹‰è¯­æ³•é”™è¯¯
- ç»Ÿä¸€å¼‚æ­¥å‡½æ•°è°ƒç”¨æ–¹å¼
- è§„èŒƒåŒ–ä»£ç é£æ ¼å’Œæ³¨é‡Š

### âœ… **v1.3.0 æœ€ç»ˆæ¸…ç†å®Œæˆ**
- **sidepanel.js æˆä¸ºçº¯å¯åŠ¨å™¨**: åˆ é™¤äº†æ‰€æœ‰æ®‹ç•™çš„ä¸šåŠ¡é€»è¾‘å‡½æ•°
  - ç§»é™¤äº†é‡å¤çš„ `sortPromptsByCreatedTime()` å‡½æ•°
  - å®Œå…¨åˆ é™¤äº† `loadUserPrompts()` å‡½æ•°
  - å°† `showCustomAlert()` å‡½æ•°è¿ç§»åˆ° `uiManager.js`
- **å…¨å±€å˜é‡æ¸…ç†**: åªä¿ç•™å¯åŠ¨å™¨å¿…éœ€çš„ `currentUser` å˜é‡
- **äº‹ä»¶å¤„ç†ä¼˜åŒ–**: ç³»ç»Ÿä¸»é¢˜å˜åŒ–å§”æ‰˜ç»™ `appController.handleSystemThemeChange()`
- **æ¶æ„ç›®æ ‡è¾¾æˆ**: sidepanel.js ç°åœ¨æ˜¯ä¸€ä¸ªçº¯ç²¹çš„å¯åŠ¨å™¨ï¼Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½åœ¨å¯¹åº”çš„æ¨¡å—ä¸­  

## æ ¸å¿ƒæ•°æ®æµåˆ†æ

### 1. æç¤ºè¯æ•°æ®åŠ è½½æµç¨‹

```
ç”¨æˆ·æ“ä½œ/é¡µé¢åˆå§‹åŒ–
    â†“
sidepanel.js: initializeApp()
    â†“
sidepanel.js: loadUserPrompts()
    â†“
chrome.runtime.sendMessage({ type: 'GET_ALL_PROMPTS' })
    â†“
background.js: æ¶ˆæ¯ç›‘å¬å™¨å¤„ç† GET_ALL_PROMPTS
    â†“
data-service.js: dataService.getAllPrompts()
    â†“
chrome.storage.local.get([STORAGE_KEYS.PROMPTS])
    â†“
è¿”å›åŸå§‹æ•°æ®ï¼ˆåŒ…å« is_deleted: true çš„æ•°æ®ï¼‰
    â†“
sidepanel.js: renderPrompts(allPrompts)
    â†“
DOMæ¸²æŸ“ï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬è½¯åˆ é™¤çš„ï¼‰
```

### 2. æç¤ºè¯åˆ é™¤æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»åˆ é™¤æŒ‰é’®
    â†“
sidepanel.js: åˆ é™¤äº‹ä»¶å¤„ç†
    â†“
chrome.runtime.sendMessage({ type: 'DELETE_PROMPT', promptId })
    â†“
background.js: æ¶ˆæ¯ç›‘å¬å™¨å¤„ç† DELETE_PROMPT
    â†“
data-service.js: dataService.deletePrompt(promptId)
    â†“
è®¾ç½® is_deleted: true, updated_at: new Date().toISOString()
    â†“
data-service.js: _triggerSync('update', promptData)
    â†“
sync-service.js: åŒæ­¥åˆ°äº‘ç«¯ï¼ˆè½¯åˆ é™¤çŠ¶æ€ï¼‰
    â†“
chrome.storage.onChanged äº‹ä»¶è§¦å‘
    â†“
sidepanel.js: è‡ªåŠ¨åˆ·æ–°UIï¼ˆä½†ä»æ˜¾ç¤ºè½¯åˆ é™¤æ•°æ®ï¼‰
```

### 3. ç™»å½•åŒæ­¥æµç¨‹

```
ç”¨æˆ·ç™»å½•
    â†“
auth-service.js: è®¤è¯æˆåŠŸ
    â†“
sync-service.js: å¯åŠ¨åŒæ­¥
    â†“
ä»äº‘ç«¯è·å–æ•°æ®ï¼ˆåŒ…å«è½¯åˆ é™¤çŠ¶æ€ï¼‰
    â†“
data-service.js: æœ¬åœ°æ•°æ®åˆå¹¶
    â†“
getAllPrompts() è¿”å›æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å« is_deleted: trueï¼‰
    â†“
UIæ˜¾ç¤ºï¼ˆè½¯åˆ é™¤çš„æç¤ºè¯é‡æ–°å‡ºç°ï¼‰
```

### 4. æ‰‹åŠ¨åŒæ­¥æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»æ‰‹åŠ¨åŒæ­¥æŒ‰é’®
    â†“
appController.js: handleManualSync()
    â†“
æ˜¾ç¤ºåŒæ­¥ä¸­çŠ¶æ€: ui.showSyncStatus('syncing')
    â†“
sync-service.js: performFullSync()
    â†“
ä¼šè¯çŠ¶æ€æ£€æŸ¥: authService.getSession()
    â†“
ç½‘ç»œè¿æ¥æµ‹è¯•: fetch('https://httpbin.org/get')
    â†“
Supabaseå®¢æˆ·ç«¯çŠ¶æ€éªŒè¯
    â†“
æ‰§è¡Œå®Œæ•´åŒæ­¥: _fetchCloudPrompts() + _syncToCloud()
    â†“
æ›´æ–°æœ€ååŒæ­¥æ—¶é—´: _updateLastSyncTime()
    â†“
åŒæ­¥æˆåŠŸ: ui.updateSyncTime() + ui.showSyncStatus('success')
    â†“
âŒ é”™è¯¯å¤„ç†: æ•è·å¹¶è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
```

## å…³é”®æ–‡ä»¶å’Œå‡½æ•°æ˜ å°„

### æ•°æ®æœåŠ¡å±‚ (`src/utils/data-service.js`)

| å‡½æ•°å | è¡Œå· | åŠŸèƒ½ | è°ƒç”¨è€… |
|--------|------|------|--------|
| `getAllPrompts()` | 237 | è·å–æ‰€æœ‰æç¤ºè¯ | background.js, sync-service.js |
| `addPrompt()` | 258 | æ·»åŠ æ–°æç¤ºè¯ | background.js |
| `updatePrompt()` | 320 | æ›´æ–°æç¤ºè¯ | background.js |
| `deletePrompt()` | 370 | è½¯åˆ é™¤æç¤ºè¯ | background.js |
| `_triggerSync()` | 680 | è§¦å‘äº‘ç«¯åŒæ­¥ | å†…éƒ¨è°ƒç”¨ |

### UIå±‚ (`src/sidepanel/sidepanel.js`)

| å‡½æ•°å | è¡Œå· | åŠŸèƒ½ | è°ƒç”¨å…³ç³» |
|--------|------|------|----------|
| `initializeApp()` | 1281 | åº”ç”¨åˆå§‹åŒ– | é¡µé¢åŠ è½½æ—¶è°ƒç”¨ |
| `loadUserPrompts()` | 432 | åŠ è½½ç”¨æˆ·æç¤ºè¯ | initializeApp() è°ƒç”¨ |
| `renderPrompts()` | ~800 | æ¸²æŸ“æç¤ºè¯åˆ—è¡¨ | loadUserPrompts() è°ƒç”¨ |
| `sortPromptsByCreatedTime()` | ~400 | æŒ‰æ—¶é—´æ’åº | loadUserPrompts() è°ƒç”¨ |

### åº”ç”¨æ§åˆ¶å±‚ (`src/sidepanel/appController.js`)

| å‡½æ•°å | è¡Œå· | åŠŸèƒ½ | è°ƒç”¨å…³ç³» |
|--------|------|------|----------|
| `handleManualSync()` | ~200 | å¤„ç†æ‰‹åŠ¨åŒæ­¥ | UIæŒ‰é’®ç‚¹å‡»è§¦å‘ |
| `handleSystemThemeChange()` | ~150 | å¤„ç†ç³»ç»Ÿä¸»é¢˜å˜åŒ– | ç³»ç»Ÿäº‹ä»¶è§¦å‘ |
| `loadUserPrompts()` | ~100 | åŠ è½½ç”¨æˆ·æç¤ºè¯ | åº”ç”¨åˆå§‹åŒ–è°ƒç”¨ |
| `renderPrompts()` | ~250 | æ¸²æŸ“æç¤ºè¯åˆ—è¡¨ | loadUserPrompts() è°ƒç”¨ |

### UIç®¡ç†å±‚ (`src/sidepanel/uiManager.js`)

| å‡½æ•°å | è¡Œå· | åŠŸèƒ½ | è°ƒç”¨å…³ç³» |
|--------|------|------|----------|
| `updateSyncTime()` | ~500 | æ›´æ–°åŒæ­¥æ—¶é—´æ˜¾ç¤º | åŒæ­¥å®Œæˆåè°ƒç”¨ |
| `showSyncStatus()` | ~400 | æ˜¾ç¤ºåŒæ­¥çŠ¶æ€ | åŒæ­¥è¿‡ç¨‹ä¸­è°ƒç”¨ |
| `showCustomAlert()` | ~300 | æ˜¾ç¤ºè‡ªå®šä¹‰æç¤º | é”™è¯¯å¤„ç†æ—¶è°ƒç”¨ |
| `showToast()` | ~600 | æ˜¾ç¤ºToasté€šçŸ¥ | æ“ä½œåé¦ˆæ—¶è°ƒç”¨ |

### åå°æœåŠ¡ (`src/background.js`)

| æ¶ˆæ¯ç±»å‹ | è¡Œå· | å¤„ç†å‡½æ•° | æ•°æ®æµå‘ |
|----------|------|----------|----------|
| `GET_ALL_PROMPTS` | 243 | è·å–æ‰€æœ‰æç¤ºè¯ | sidepanel â†’ background â†’ data-service |
| `DELETE_PROMPT` | ~300 | åˆ é™¤æç¤ºè¯ | sidepanel â†’ background â†’ data-service |
| `ADD_PROMPT` | ~200 | æ·»åŠ æç¤ºè¯ | sidepanel â†’ background â†’ data-service |
| `UPDATE_PROMPT` | ~250 | æ›´æ–°æç¤ºè¯ | sidepanel â†’ background â†’ data-service |

### åŒæ­¥æœåŠ¡ (`src/utils/sync-service.js`)

| å‡½æ•°å | è¡Œå· | åŠŸèƒ½ | è°ƒç”¨æ—¶æœº |
|--------|------|------|----------|
| `performFullSync()` | ~400 | æ‰§è¡Œå®Œæ•´åŒæ­¥ | æ‰‹åŠ¨åŒæ­¥/ç™»å½•åŒæ­¥ |
| `_fetchCloudPrompts()` | ~600 | è·å–äº‘ç«¯æ•°æ® | åŒæ­¥è¿‡ç¨‹ä¸­ |
| `_syncToCloud()` | ~835 | åŒæ­¥åˆ°äº‘ç«¯ | æ•°æ®å˜æ›´æ—¶ |
| `_batchUploadPrompts()` | ~536 | æ‰¹é‡ä¸Šä¼ æç¤ºè¯ | äº‘ç«¯åŒæ­¥æ—¶ |
| `_updateLastSyncTime()` | ~300 | æ›´æ–°æœ€ååŒæ­¥æ—¶é—´ | åŒæ­¥å®Œæˆå |
| `syncToCloud()` | ~150 | åŒæ­¥åˆ°äº‘ç«¯ | æ•°æ®å˜æ›´æ—¶ |
| `syncFromCloud()` | ~200 | ä»äº‘ç«¯åŒæ­¥ | ç™»å½•æ—¶/å®šæœŸåŒæ­¥ |
| `mergePrompts()` | ~300 | æ•°æ®åˆå¹¶ | åŒæ­¥è¿‡ç¨‹ä¸­ |

## é—®é¢˜ç‚¹åˆ†æ

### å·²ä¿®å¤ï¼šæ‰‹åŠ¨åŒæ­¥å¤±è´¥Bug (2024-12-28)

**é—®é¢˜æè¿°**: æ‰‹åŠ¨åŒæ­¥å¤±è´¥ï¼ŒæŠ›å‡º `ReferenceError: updateSyncTime is not defined` é”™è¯¯

**æ ¹æœ¬åŸå› **: `appController.js` ä¸­è°ƒç”¨äº†æœªå®šä¹‰çš„ `updateSyncTime()` å‡½æ•°

**æ•°æ®æµé—®é¢˜**:
```
ç”¨æˆ·ç‚¹å‡»æ‰‹åŠ¨åŒæ­¥
    â†“
appController.js: handleManualSync()
    â†“
âŒ è°ƒç”¨ updateSyncTime() // å‡½æ•°æœªå®šä¹‰
    â†“
æŠ›å‡º ReferenceError é”™è¯¯
    â†“
åŒæ­¥å¤±è´¥ï¼Œä½†æ—¶é—´å¯èƒ½å·²æ›´æ–°
```

**ä¿®å¤æ–¹æ¡ˆ**: å°† `updateSyncTime()` æ›´æ­£ä¸º `ui.updateSyncTime()`

### å†å²Bugï¼šè½¯åˆ é™¤æ•°æ®æ˜¾ç¤ºé—®é¢˜

1. **æ•°æ®è·å–é˜¶æ®µ**:
   ```
   getAllPrompts() â†’ è¿”å›æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å« is_deleted: trueï¼‰
   âŒ ç¼ºå°‘è¿‡æ»¤é€»è¾‘
   ```

2. **UIæ¸²æŸ“é˜¶æ®µ**:
   ```
   renderPrompts(allPrompts) â†’ æ¸²æŸ“æ‰€æœ‰ä¼ å…¥æ•°æ®
   âŒ æœªæ£€æŸ¥ is_deleted å­—æ®µ
   ```

3. **åŒæ­¥é˜¶æ®µ**:
   ```
   äº‘ç«¯æ•°æ® â†’ æœ¬åœ°åˆå¹¶ â†’ getAllPrompts() â†’ UIæ˜¾ç¤º
   âŒ æ•´ä¸ªé“¾è·¯éƒ½æ²¡æœ‰è¿‡æ»¤è½¯åˆ é™¤æ•°æ®
   ```

## æ¶æ„è®¾è®¡æ¨¡å¼

### æ¶ˆæ¯é©±åŠ¨æ¶æ„
- **sidepanel** â†” **background** â†” **data-service**
- ä½¿ç”¨ `chrome.runtime.sendMessage` è¿›è¡Œé€šä¿¡
- å¼‚æ­¥å“åº”æ¨¡å¼ï¼Œæ”¯æŒå¤æ‚æ•°æ®æ“ä½œ

### æ•°æ®å­˜å‚¨æ¨¡å¼
- ä½¿ç”¨ `chrome.storage.local` ä½œä¸ºæœ¬åœ°å­˜å‚¨
- è½¯åˆ é™¤æ¨¡å¼ï¼š`is_deleted: true` è€Œéç‰©ç†åˆ é™¤
- æ—¶é—´æˆ³è¿½è¸ªï¼š`created_at`, `updated_at` å­—æ®µ

### åŒæ­¥ç­–ç•¥
- å¢é‡åŒæ­¥ï¼šåŸºäº `updated_at` æ—¶é—´æˆ³
- å†²çªè§£å†³ï¼šæœ€æ–°æ—¶é—´æˆ³ä¼˜å…ˆ
- é‡è¯•æœºåˆ¶ï¼šå¤±è´¥æ“ä½œåŠ å…¥é‡è¯•é˜Ÿåˆ—

## æ€§èƒ½è€ƒè™‘

### æ•°æ®é‡è¯„ä¼°
- æç¤ºè¯æ•°é‡ï¼šé€šå¸¸ < 1000 æ¡
- å•æ¡æ•°æ®å¤§å°ï¼š< 10KB
- è¿‡æ»¤æ“ä½œå¤æ‚åº¦ï¼šO(n)ï¼Œæ€§èƒ½å½±å“å¯å¿½ç•¥

### ä¼˜åŒ–å»ºè®®
1. **æ‡’åŠ è½½**: å¤§é‡æ•°æ®æ—¶è€ƒè™‘åˆ†é¡µåŠ è½½
2. **ç¼“å­˜ç­–ç•¥**: é¿å…é‡å¤çš„æ•°æ®è·å–æ“ä½œ
3. **ç´¢å¼•ä¼˜åŒ–**: è€ƒè™‘ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•

## æ‰©å±•æ€§è€ƒè™‘

### æœªæ¥åŠŸèƒ½æ”¯æŒ
1. **å›æ”¶ç«™åŠŸèƒ½**: éœ€è¦èƒ½å¤Ÿè·å–è½¯åˆ é™¤æ•°æ®
2. **æ‰¹é‡æ“ä½œ**: éœ€è¦æ”¯æŒæ‰¹é‡è½¯åˆ é™¤/æ¢å¤
3. **æ•°æ®å¯¼å‡º**: å¯èƒ½éœ€è¦åŒ…å«/æ’é™¤è½¯åˆ é™¤æ•°æ®çš„é€‰é¡¹

### å»ºè®®çš„APIè®¾è®¡
```javascript
// å½“å‰
getAllPrompts() // åº”è¯¥é»˜è®¤è¿‡æ»¤è½¯åˆ é™¤

// å»ºè®®æ‰©å±•
getAllPrompts(options = {}) {
  const { includeDeleted = false, category = null, limit = null } = options;
  // æ”¯æŒå¤šç§è¿‡æ»¤é€‰é¡¹
}
```

## è°ƒè¯•å’Œç›‘æ§

### å…³é”®æ—¥å¿—ç‚¹
1. `getAllPrompts()`: è®°å½•è¿”å›æ•°æ®é‡å’Œè¿‡æ»¤çŠ¶æ€
2. `deletePrompt()`: è®°å½•è½¯åˆ é™¤æ“ä½œ
3. `renderPrompts()`: è®°å½•æ¸²æŸ“çš„æ•°æ®é‡
4. åŒæ­¥æ“ä½œ: è®°å½•åŒæ­¥çš„æ•°æ®å˜æ›´

### é”™è¯¯å¤„ç†æ¨¡å¼
- æ•°æ®å±‚ï¼šæŠ›å‡ºå…·ä½“é”™è¯¯ä¿¡æ¯
- UIå±‚ï¼šæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- åå°ï¼šè®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—

### åŒæ­¥é”™è¯¯è¯Šæ–­æœºåˆ¶ (2024-12-28 æ–°å¢)

**å¢å¼ºçš„é”™è¯¯æ—¥å¿—è®°å½•**:
1. **performFullSync()**: è®°å½•é”™è¯¯åç§°ã€æ¶ˆæ¯ã€å †æ ˆå’ŒåŸå› 
2. **_batchUploadPrompts()**: è®°å½•Supabaseé”™è¯¯ç ã€æ¶ˆæ¯ã€è¯¦æƒ…å’Œæç¤º
3. **_fetchCloudPrompts()**: è®°å½•äº‘ç«¯æ•°æ®è·å–å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯

**ä¼šè¯çŠ¶æ€æ£€æŸ¥**:
- æ£€æŸ¥ç”¨æˆ·ä¼šè¯æ˜¯å¦è¿‡æœŸ
- è®°å½•ç”¨æˆ·IDã€é‚®ç®±ã€ä¼šè¯æœ‰æ•ˆæ€§åŠè¿‡æœŸæ—¶é—´

**ç½‘ç»œè¿æ¥éªŒè¯**:
- æµ‹è¯•ç½‘ç»œè¿æ¥çŠ¶æ€
- éªŒè¯Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–çŠ¶æ€

**å¸¸è§é”™è¯¯ç±»å‹**:
1. `ReferenceError`: å‡½æ•°æœªå®šä¹‰ï¼ˆå¦‚updateSyncTimeé—®é¢˜ï¼‰
2. `NetworkError`: ç½‘ç»œè¿æ¥å¤±è´¥
3. `AuthError`: ç”¨æˆ·ä¼šè¯è¿‡æœŸ
4. `SupabaseError`: æ•°æ®åº“æ“ä½œå¤±è´¥

## æœ€æ–°ä¿®å¤è®°å½•

### 2024-12-28: æ‰‹åŠ¨åŒæ­¥å¤±è´¥Bugä¿®å¤

**ä¿®å¤æ–‡ä»¶**:
- `src/sidepanel/appController.js`: ä¿®æ­£ `updateSyncTime()` è°ƒç”¨
- `src/utils/sync-service.js`: å¢å¼ºé”™è¯¯è¯Šæ–­å’Œæ—¥å¿—è®°å½•

**æ–°å¢è¯Šæ–­åŠŸèƒ½**:
- ä¼šè¯çŠ¶æ€æ£€æŸ¥
- ç½‘ç»œè¿æ¥æµ‹è¯•
- Supabaseå®¢æˆ·ç«¯çŠ¶æ€éªŒè¯
- è¯¦ç»†é”™è¯¯æ—¥å¿—è®°å½•

**ç›¸å…³æ–‡æ¡£**:
- `ä¿®å¤æ‰‹åŠ¨åŒæ­¥å¤±è´¥ä½†æ—¶é—´æ›´æ–°Bug-bugfix-20241228-190000.md`
- `æ‰‹åŠ¨åŒæ­¥å¤±è´¥è¯Šæ–­æŒ‡å—-debug-20241228-191500.md`

---

**ç»´æŠ¤è¯´æ˜**: æ­¤æ–‡æ¡£åº”åœ¨é‡å¤§æ¶æ„å˜æ›´æ—¶æ›´æ–°ï¼Œç¡®ä¿å›¢é˜Ÿå¯¹æ•°æ®æµçš„ç†è§£ä¿æŒä¸€è‡´ã€‚æ¯æ¬¡Bugä¿®å¤ååº”æ›´æ–°ç›¸åº”çš„æ•°æ®æµåˆ†æã€‚