# PromptCraft 项目函数调用逻辑分析

**创建时间**: 2025-06-29  
**分析目的**: 记录项目中关键数据流和函数调用关系，便于后续维护和调试  

## 核心数据流分析

### 1. 提示词数据加载流程

```
用户操作/页面初始化
    ↓
sidepanel.js: initializeApp()
    ↓
sidepanel.js: loadUserPrompts()
    ↓
chrome.runtime.sendMessage({ type: 'GET_ALL_PROMPTS' })
    ↓
background.js: 消息监听器处理 GET_ALL_PROMPTS
    ↓
data-service.js: dataService.getAllPrompts()
    ↓
chrome.storage.local.get([STORAGE_KEYS.PROMPTS])
    ↓
返回原始数据（包含 is_deleted: true 的数据）
    ↓
sidepanel.js: renderPrompts(allPrompts)
    ↓
DOM渲染（显示所有数据，包括软删除的）
```

### 2. 提示词删除流程

```
用户点击删除按钮
    ↓
sidepanel.js: 删除事件处理
    ↓
chrome.runtime.sendMessage({ type: 'DELETE_PROMPT', promptId })
    ↓
background.js: 消息监听器处理 DELETE_PROMPT
    ↓
data-service.js: dataService.deletePrompt(promptId)
    ↓
设置 is_deleted: true, updated_at: new Date().toISOString()
    ↓
data-service.js: _triggerSync('update', promptData)
    ↓
sync-service.js: 同步到云端（软删除状态）
    ↓
chrome.storage.onChanged 事件触发
    ↓
sidepanel.js: 自动刷新UI（但仍显示软删除数据）
```

### 3. 登录同步流程

```
用户登录
    ↓
auth-service.js: 认证成功
    ↓
sync-service.js: 启动同步
    ↓
从云端获取数据（包含软删除状态）
    ↓
data-service.js: 本地数据合并
    ↓
getAllPrompts() 返回所有数据（包含 is_deleted: true）
    ↓
UI显示（软删除的提示词重新出现）
```

## 关键文件和函数映射

### 数据服务层 (`src/utils/data-service.js`)

| 函数名 | 行号 | 功能 | 调用者 |
|--------|------|------|--------|
| `getAllPrompts()` | 237 | 获取所有提示词 | background.js, sync-service.js |
| `addPrompt()` | 258 | 添加新提示词 | background.js |
| `updatePrompt()` | 320 | 更新提示词 | background.js |
| `deletePrompt()` | 370 | 软删除提示词 | background.js |
| `_triggerSync()` | 680 | 触发云端同步 | 内部调用 |

### UI层 (`src/sidepanel/sidepanel.js`)

| 函数名 | 行号 | 功能 | 调用关系 |
|--------|------|------|----------|
| `initializeApp()` | 1281 | 应用初始化 | 页面加载时调用 |
| `loadUserPrompts()` | 432 | 加载用户提示词 | initializeApp() 调用 |
| `renderPrompts()` | ~800 | 渲染提示词列表 | loadUserPrompts() 调用 |
| `sortPromptsByCreatedTime()` | ~400 | 按时间排序 | loadUserPrompts() 调用 |

### 后台服务 (`src/background.js`)

| 消息类型 | 行号 | 处理函数 | 数据流向 |
|----------|------|----------|----------|
| `GET_ALL_PROMPTS` | 243 | 获取所有提示词 | sidepanel → background → data-service |
| `DELETE_PROMPT` | ~300 | 删除提示词 | sidepanel → background → data-service |
| `ADD_PROMPT` | ~200 | 添加提示词 | sidepanel → background → data-service |
| `UPDATE_PROMPT` | ~250 | 更新提示词 | sidepanel → background → data-service |

### 同步服务 (`src/utils/sync-service.js`)

| 函数名 | 行号 | 功能 | 调用时机 |
|--------|------|------|----------|
| `syncToCloud()` | ~150 | 同步到云端 | 数据变更时 |
| `syncFromCloud()` | ~200 | 从云端同步 | 登录时/定期同步 |
| `mergePrompts()` | ~300 | 数据合并 | 同步过程中 |

## 问题点分析

### 当前Bug的数据流问题

1. **数据获取阶段**:
   ```
   getAllPrompts() → 返回所有数据（包含 is_deleted: true）
   ❌ 缺少过滤逻辑
   ```

2. **UI渲染阶段**:
   ```
   renderPrompts(allPrompts) → 渲染所有传入数据
   ❌ 未检查 is_deleted 字段
   ```

3. **同步阶段**:
   ```
   云端数据 → 本地合并 → getAllPrompts() → UI显示
   ❌ 整个链路都没有过滤软删除数据
   ```

## 架构设计模式

### 消息驱动架构
- **sidepanel** ↔ **background** ↔ **data-service**
- 使用 `chrome.runtime.sendMessage` 进行通信
- 异步响应模式，支持复杂数据操作

### 数据存储模式
- 使用 `chrome.storage.local` 作为本地存储
- 软删除模式：`is_deleted: true` 而非物理删除
- 时间戳追踪：`created_at`, `updated_at` 字段

### 同步策略
- 增量同步：基于 `updated_at` 时间戳
- 冲突解决：最新时间戳优先
- 重试机制：失败操作加入重试队列

## 性能考虑

### 数据量评估
- 提示词数量：通常 < 1000 条
- 单条数据大小：< 10KB
- 过滤操作复杂度：O(n)，性能影响可忽略

### 优化建议
1. **懒加载**: 大量数据时考虑分页加载
2. **缓存策略**: 避免重复的数据获取操作
3. **索引优化**: 考虑为常用查询字段建立索引

## 扩展性考虑

### 未来功能支持
1. **回收站功能**: 需要能够获取软删除数据
2. **批量操作**: 需要支持批量软删除/恢复
3. **数据导出**: 可能需要包含/排除软删除数据的选项

### 建议的API设计
```javascript
// 当前
getAllPrompts() // 应该默认过滤软删除

// 建议扩展
getAllPrompts(options = {}) {
  const { includeDeleted = false, category = null, limit = null } = options;
  // 支持多种过滤选项
}
```

## 调试和监控

### 关键日志点
1. `getAllPrompts()`: 记录返回数据量和过滤状态
2. `deletePrompt()`: 记录软删除操作
3. `renderPrompts()`: 记录渲染的数据量
4. 同步操作: 记录同步的数据变更

### 错误处理模式
- 数据层：抛出具体错误信息
- UI层：显示用户友好的错误提示
- 后台：记录详细错误日志

---

**维护说明**: 此文档应在重大架构变更时更新，确保团队对数据流的理解保持一致。